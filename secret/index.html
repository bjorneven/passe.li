<!doctype html>
<html lang="en">
    <head>
          <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
   integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
   crossorigin=""/>
    <!-- Make sure you put this AFTER Leaflet's CSS -->
 <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
 integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
 crossorigin=""></script>
 <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"/>
 <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/leaflet.geodesic"></script>
 <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootswatch/4.5.2/united/bootstrap.min.css"/>


 <title>Skymatix Route Viewer</title>

</head>

    <style>

#mapid {
  position: relative;
  border: 1px solid black;
  border-radius: 8px;
  height: 100%;  /* or as desired */
  width: 100%;  /* This means "100% of the width of its container", the .col-md-8 */
}
html,body, #container {
    height: 100%;
    width: 100%;
}
    </style>
    <body>
        <div id="container" class="container-fluid h-100">
            <div class="row h-100">
                <div class="col-lg-2 col-sm-3 h-100">
                   
                    <div>
                        <form id="departureFilterForm">

                            <div class="form-group">
                                <label for="inputDepartureFilter">ICAO departure</label>
                                <input type="text" class="form-control" id="inputDepartureFilter" aria-describedby="inputDepartureFilterHelp" placeholder="ICAO departure apt.">
                                <small id="inputDepartureFilterHelp" class="form-text text-muted">Enter the 4 letter ICAO airport code to filter on.</small>
                                <button type="submit" name="departureFilterBtn" class="btn btn-primary">Filter</button>

                            </div>
                        </form>
                  
                    </div>
                    <div id="infomap">Hover over a route to see info</div>
                </div>
                <div  class="col-lg-10 col-sm-9 h-100">
                    <div id="mapid"></div>

                </div>
            </div>
        </div>
        <script>

            const lineOptions = {
                weight: 4,
                opacity: 0.5,
                color: 'grey',
            };

            var mymap = L.map('mapid').setView([51.505, -0.09], 5);
            mymap.invalidateSize();

            L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
                maxZoom: 18,
                id: 'mapbox/streets-v11',
                tileSize: 512,
                zoomOffset: -1,
                accessToken: 'pk.eyJ1IjoiYmpvcm5ldmVuIiwiYSI6ImNrajY2emVnNzRjankycm40Z2U0cmkwMmYifQ.8SaqWp_StHtO4_Aqa7W5nA'
            }).addTo(mymap);
            L.Layer.include({
                getProps: function () {
                    var feature = this.feature = this.feature || {}; // Initialize the feature, if missing.
                    feature.type = 'Feature';
                    feature.properties = feature.properties || {}; // Initialize the properties, if missing.
                    return feature.properties;
                }
                });

            var featureRouteGroup = L.layerGroup().addTo(mymap);

            var allRoutes = [];

            $.getJSON('./route.json', function(routes) {
                allRoutes = routes;
                allRoutes.forEach(forEveryRoute)
            });

            $("#departureFilterForm").submit(function() {
                const filt = $("#inputDepartureFilter").val();
                console.log("Filter submitted for airport " + filt);

                addFilter(filt);
                return false;
            });

            var filterRoutes = [];

            function addFilter(f) {
                console.log("Filtering departures from " + f.toUpperCase());
                var filterRoute = [];

                if (f.trim() === "") {
                    filterRoute = allRoutes;
                } else {
                    filterRoute = allRoutes.filter( el => {
                    return el.DptAirport.trim().toUpperCase() == f.trim().toUpperCase();
                    });
                }
                

                self.featureRouteGroup.clearLayers();
                filterRoute.forEach(forEveryRoute);
                
            }

            function submitDepartureFilter() {
                const filt = document.departureFilterForm.inputDepartureFilter.value;
                addFilter(filt);
            }
            function hideRoutes() {
                featureRouteGroup.removeFrom(mymap);
            }
            
            function showRoutes() {
                featureRouteGroup.addTo(mymap);
            }

            var self = this;
            function forEveryRoute(value, index, array) {
               
                var first = value.Fixes[0]
                console.log(value.DptAirport);

                // TODO string equals
             //   if (value.DptAirport.toUpperCase() == filterRoute.toUpperCase()) {
               //     console.log("ENBR found")
               // }
                
                var last = value.Fixes[value.Fixes.length - 1]
                
                L.circle([first.Lat, first.Lon], {
                    color: 'red',
                    fillColor: '#f03',
                    fillOpacity: 0.5,
                    radius: 500
                }).addTo(mymap);
                L.circle([last.Lat, last.Lon], {
                    color: 'red',
                    fillColor: '#f03',
                    fillOpacity: 0.5,
                    radius: 500
                }).addTo(mymap);

                var from = new L.LatLng(first.Lat, first.Lon); 
                var to = new L.LatLng(last.Lat, last.Lon); 
                var i;
                const places = []
                for (i = 0; i < value.Fixes.length; i++) {
                    var v =  value.Fixes[i]
                    var from = new L.LatLng(v.Lat, v.Lon); 
                    places.push(from)

                }

                const geodesicLine = new L.Geodesic(places, lineOptions)
                geodesicLine.getProps().route = value

                geodesicLine.addTo(featureRouteGroup);
                
                geodesicLine.on('mouseout',(e) => {
                    
                    $('#infomap').html('Hover over a route to see info');
                });
                
                geodesicLine.on('mouseover',(e) => {
                    var source =   e.sourceTarget;
                    var ri = source.getProps().route;

                    $('#infomap').html(
                    'Departure:' + ri.DptAirport + '<br/>' + 
                    'Arrival:' + ri.ArrAirport + '<br/>') 
                });
            }
        </script>
    </body>
</html>